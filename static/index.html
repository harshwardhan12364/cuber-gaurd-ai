<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberGuard A.I. | National Defense Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        cyber: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            accent: '#6366f1', // Indigo 500
                            glow: '#818cf8',   // Indigo 400
                            danger: '#ef4444',
                            success: '#10b981',
                            warning: '#f59e0b'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'scan-line': 'scan 3s linear infinite',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        },
                        scan: {
                            '0%': { top: '0%' },
                            '50%': { top: '100%' },
                            '100%': { top: '0%' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0b1120;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.15), transparent 40%),
                radial-gradient(circle at 0% 90%, rgba(16, 185, 129, 0.1), transparent 30%);
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .input-glow:focus {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.8);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .msg-scammer {
            background: linear-gradient(135deg, #281515 0%, #450a0a 100%);
            border-left: 3px solid #ef4444;
            color: #fca5a5;
        }

        .msg-agent {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-right: 3px solid #6366f1;
            color: #e2e8f0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #818cf8;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .scan-overlay {
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.2), transparent);
            height: 20px;
            position: absolute;
            width: 100%;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-sm selection:bg-indigo-500 selection:text-white">

    <!-- HEADER -->
    <header class="h-16 glass-panel border-b-0 border-b-white/10 flex items-center justify-between px-6 z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i data-lucide="shield-check" class="w-6 h-6"></i>
                </div>
                <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-[#0f172a] rounded-full">
                </div>
            </div>
            <div>
                <h1 class="font-bold text-xl leading-none tracking-tight">CyberGuard <span
                        class="text-indigo-400">A.I.</span></h1>
                <p class="text-[10px] font-bold tracking-[0.2em] text-cyan-400 uppercase mt-1">Classification System
                    v2.0</p>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="hidden md:flex items-center gap-2 text-[10px] font-mono text-slate-400">
                <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                    SERVER: ONLINE</span>
                <span class="w-px h-3 bg-slate-700"></span>
                <span class="flex items-center gap-1"><span
                        class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-pulse"></span> ML: ACTIVE</span>
            </div>
            <button onclick="togglePolicePanel()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-500/30 border border-blue-400/30 flex items-center gap-2 group relative overflow-hidden">
                <div
                    class="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500">
                </div>
                <i data-lucide="shield-alert" class="w-3 h-3 animate-pulse"></i> SAFETY ASSISTANT
            </button>
            <button id="exportBtn" onclick="exportReport()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg shadow-indigo-500/30 border border-indigo-400/30 flex items-center gap-2">
                <i data-lucide="download" class="w-3 h-3"></i> EXPORT REPORT
            </button>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 p-4 lg:p-6 grid grid-cols-12 gap-6 overflow-hidden max-w-[1800px] mx-auto w-full relative z-10">

        <!-- 1. LEFT PANEL: DEEPER SCANNING TOOLS -->
        <section class="col-span-12 lg:col-span-3 flex flex-col gap-4 overflow-y-auto pr-1">
            <div class="flex items-center justify-between mb-1">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest"><i data-lucide="scan-line"
                        class="inline w-3 h-3 mr-1"></i> Forensic Tools</h2>
            </div>

            <!-- Tool Container -->
            <div class="space-y-4">

                <!-- URL Scanner -->
                <div class="glass-panel p-4 rounded-xl group hover:border-indigo-500/50 transition duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-400 font-bold">
                            <i data-lucide="globe" class="w-4 h-4"></i> URL Analysis
                        </div>
                        <span
                            class="text-[10px] font-mono bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">HTTP/S</span>
                    </div>
                    <div class="relative">
                        <input type="text" id="check-link" placeholder="Enter suspicious link..."
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-indigo-500 transition-colors text-slate-300 placeholder-slate-600">
                        <button onclick="runCheck('link')"
                            class="absolute right-1 top-1 p-1 bg-indigo-600 rounded-md text-white hover:bg-indigo-500 transition">
                            <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div id="res-link" class="hidden mt-3 pt-3 border-t border-slate-700/50 text-xs"></div>
                </div>

                <!-- Phone Scanner -->
                <div class="glass-panel p-4 rounded-xl group hover:border-emerald-500/50 transition duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-emerald-400 font-bold">
                            <i data-lucide="phone-call" class="w-4 h-4"></i> Phone Trace
                        </div>
                        <span
                            class="text-[10px] font-mono bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">H.L.R.</span>
                    </div>
                    <div class="relative">
                        <input type="text" id="check-phone" placeholder="+91 98765..."
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-emerald-500 transition-colors text-slate-300 placeholder-slate-600">
                        <button onclick="runCheck('phone')"
                            class="absolute right-1 top-1 p-1 bg-emerald-600 rounded-md text-white hover:bg-emerald-500 transition">
                            <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div id="res-phone" class="hidden mt-3 pt-3 border-t border-slate-700/50 text-xs"></div>
                </div>

                <!-- UPI Scanner -->
                <div class="glass-panel p-4 rounded-xl group hover:border-cyan-500/50 transition duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-cyan-400 font-bold">
                            <i data-lucide="wallet" class="w-4 h-4"></i> UPI / VPA Logic
                        </div>
                        <span
                            class="text-[10px] font-mono bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">FINTECH</span>
                    </div>
                    <div class="relative">
                        <input type="text" id="check-upi" placeholder="scammer@bank"
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-cyan-500 transition-colors text-slate-300 placeholder-slate-600">
                        <button onclick="runCheck('upi')"
                            class="absolute right-1 top-1 p-1 bg-cyan-600 rounded-md text-white hover:bg-cyan-500 transition">
                            <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>

                <!-- Harsh AI: Forensic Safety Assistant (Integrated Feature) -->
                <div
                    class="glass-panel p-4 rounded-xl group border-blue-500/30 bg-blue-900/10 hover:border-blue-500/50 transition duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-blue-400 font-bold">
                            <i data-lucide="dna" class="w-4 h-4"></i> Harsh AI Assistant
                        </div>
                        <span
                            class="text-[9px] font-bold bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30 uppercase">Neural
                            Expert</span>
                    </div>
                    <div class="relative">
                        <textarea id="police-content"
                            placeholder="Paste suspicious content (emails, chats, links) here..."
                            class="w-full h-16 bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] focus:outline-none focus:border-blue-500 transition-colors text-slate-300 placeholder-slate-600 mb-2 resize-none"></textarea>
                        <button onclick="runPoliceCheck()"
                            class="w-full py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs font-bold text-white transition-all shadow-lg shadow-blue-500/20">
                            RUN FORENSIC SCAN
                        </button>
                    </div>
                </div>

                <!-- Voice Forensic Lab: AI Voice Detection (Problem Statement 1) -->
                <div
                    class="glass-panel p-4 rounded-xl group border-amber-500/30 bg-amber-900/10 hover:border-amber-500/50 transition duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-amber-400 font-bold">
                            <i data-lucide="mic-2" class="w-4 h-4"></i> Voice Forensic Lab
                        </div>
                        <span
                            class="text-[9px] font-bold bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded border border-amber-500/30 uppercase">AI
                            vs Human</span>
                    </div>

                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="voice-lang"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] text-slate-300 focus:outline-none focus:border-amber-500">
                                <option value="English">English</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Tamil">Tamil</option>
                                <option value="Malayalam">Malayalam</option>
                                <option value="Telugu">Telugu</option>
                            </select>
                            <label
                                class="flex items-center justify-center gap-2 py-1.5 bg-slate-800 border border-slate-700 border-dashed rounded-lg cursor-pointer hover:bg-slate-700 transition-all">
                                <i data-lucide="upload" class="w-3 h-3 text-amber-400"></i>
                                <span id="file-label" class="text-[9px] text-slate-400">Upload MP3</span>
                                <input type="file" id="voice-file" accept=".mp3" class="hidden"
                                    onchange="handleVoiceFile(this)">
                            </label>
                        </div>

                        <button onclick="runVoiceDetection()" id="voice-btn"
                            class="w-full py-1.5 bg-amber-600 hover:bg-amber-500 rounded-lg text-xs font-bold text-white transition-all shadow-lg shadow-amber-500/20 flex items-center justify-center gap-2">
                            ANALYZE VOICE ORIGIN
                        </button>
                    </div>

                    <div id="res-voice" class="hidden mt-3 pt-3 border-t border-amber-500/20 text-[10px] space-y-2">
                    </div>
                </div>
            </div>
        </section>


        <!-- 2. CENTER PANEL: INTERCEPTOR CHAT -->
        <section
            class="col-span-12 lg:col-span-6 flex flex-col h-full overflow-hidden relative glass-panel rounded-2xl border-t-2 border-t-indigo-500/20">

            <!-- Chat Header -->
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <div class="absolute inset-0 w-2 h-2 rounded-full bg-red-500 animate-ping opacity-75"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm tracking-wide text-white">LIVE INTERCEPTION</h3>
                        <div class="text-[10px] text-slate-500 font-mono">ENCRYPTED CHANNEL â€¢ MONITORING</div>
                    </div>
                </div>

                <!-- Persona Switcher -->
                <div class="flex items-center gap-2 bg-slate-800 p-1 rounded-lg border border-slate-700">
                    <i data-lucide="user-cog" class="w-3 h-3 text-slate-400 ml-2"></i>
                    <select id="personaSelect" onchange="updateAgentIdentity()"
                        class="bg-transparent text-xs font-bold text-slate-300 px-2 py-1 outline-none cursor-pointer">
                        <option value="naive">Target: Naive Elderly</option>
                        <option value="skeptic">Target: Skeptic Techie</option>
                        <option value="angry">Target: Hostile User</option>
                        <option value="police">AI Assistant: Harsh (Expert)</option>
                    </select>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chatContainer" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-900/30 relative">
                <!-- Welcome Message -->
                <div class="flex justify-center my-4">
                    <div
                        class="bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 text-[10px] font-mono py-1 px-3 rounded-full">
                        SYSTEM INITIALIZED. WAITING FOR INCOMING THREATS.
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing" class="hidden px-6 pb-2">
                <div class="flex gap-1 p-3 bg-slate-800/50 rounded-xl rounded-tl-sm w-fit border border-slate-700">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-slate-900/80 backdrop-blur border-t border-white/5">
                <div class="relative flex items-center gap-2">
                    <div class="absolute left-4 text-slate-500"><i data-lucide="terminal" class="w-4 h-4"></i></div>
                    <input type="text" id="mainInput"
                        class="w-full bg-slate-800/50 border border-slate-700 text-slate-200 placeholder-slate-500 rounded-xl pl-10 pr-4 py-3.5 text-sm focus:outline-none focus:border-indigo-500 focus:bg-slate-800 transition-all font-mono shadow-inner"
                        placeholder="Paste scam message here to analyze..."
                        onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()"
                        class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white p-3.5 rounded-xl transition-all shadow-lg shadow-indigo-600/20 active:scale-95">
                        <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>


        <!-- 3. RIGHT PANEL: INTELLIGENCE DASHBOARD -->
        <section class="col-span-12 lg:col-span-3 flex flex-col gap-6">

            <!-- ML Confidence Card -->
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div
                    class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">
                </div>
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Threat Probablity</h3>
                    <i data-lucide="activity" class="w-4 h-4 text-indigo-400"></i>
                </div>

                <div class="flex items-end gap-2 mb-2">
                    <div id="ml-conf-text" class="text-5xl font-bold text-white tracking-tighter">0%</div>
                    <div class="text-xs text-slate-500 font-mono mb-2">CONFIDENCE</div>
                </div>

                <div class="bg-slate-800/50 rounded-full h-2 w-full overflow-hidden mb-3">
                    <div id="ml-bar" class="h-full bg-indigo-500 w-0 transition-all duration-1000 ease-out"></div>
                </div>

                <div id="ml-intent-text"
                    class="text-center text-xs font-mono py-1.5 px-2 bg-slate-800 rounded border border-slate-700 text-slate-300">
                    IDLE
                </div>
            </div>

            <!-- Extracted Intel -->
            <div class="glass-panel p-5 rounded-2xl flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Entities Detected</h3>
                    <div class="animate-pulse w-2 h-2 rounded-full bg-cyan-500"></div>
                </div>

                <div id="intel-list" class="flex-1 space-y-3 overflow-y-auto pr-1">
                    <div class="text-center py-10 text-slate-600 italic text-xs">
                        Scanning incoming packets...<br>No entities saved.
                    </div>
                </div>
            </div>

            <!-- UNIQUE FEATURE: EMERGENCY RESOURCES -->
            <div
                class="glass-panel p-5 rounded-2xl bg-gradient-to-br from-red-900/20 to-slate-900/50 border-red-500/20">
                <h3 class="text-xs font-bold text-red-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i data-lucide="shield-alert" class="w-4 h-4"></i> Emergency Support
                </h3>
                <div class="space-y-3">
                    <div class="bg-slate-900/80 p-3 rounded-lg border border-slate-700">
                        <div class="text-[10px] text-slate-500 uppercase font-bold">Helpline (National)</div>
                        <div class="text-lg font-bold text-white tracking-widest">1930</div>
                        <div class="text-[9px] text-red-400 mt-1">AVAILABLE 24/7 IN INDIA</div>
                    </div>
                    <button onclick="window.open('https://cybercrime.gov.in', '_blank')"
                        class="w-full bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-500/30 py-2 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2">
                        <i data-lucide="external-link" class="w-3 h-3"></i> REPORT ON OFFICIAL PORTAL
                    </button>
                    <div class="text-[9px] text-slate-500 text-center italic">
                        CyberGuard A.I. is an educational platform. For real emergencies, contact authorities
                        immediately.
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- JS LOGIC -->
    <script>
        lucide.createIcons();
        const API_URL = "/api";
        let history = [];
        let sessionId = "ML-" + Math.floor(Math.random() * 100000);

        // GLOBAL DATA TRACKER FOR EXPORT
        let extractedData = {
            phones: [],
            links: [],
            financial: [],
            triggers: []
        };
        let currentML = { intent: "IDLE", confidence: 0 };

        // --- EXPORT LOGIC ---
        function exportReport() {
            const timestamp = new Date().toLocaleString();
            let content = `CYBERGUARD AI - INTERCEPTION REPORT\n`;
            content += `Session ID: ${sessionId}\n`;
            content += `Generated: ${timestamp}\n`;
            content += `--------------------------------------------------\n\n`;

            content += `[THREAT ANALYSIS]\n`;
            content += `Final Verified Intent: ${currentML.intent.toUpperCase()}\n`;
            content += `AI Confidence Model: ${(currentML.confidence * 100).toFixed(1)}%\n\n`;

            content += `[FORENSIC INTELLIGENCE]\n`;
            content += `â€¢ Identified Phone Numbers: ${extractedData.phones.join(', ') || 'None'}\n`;
            content += `â€¢ Flagged Links: ${extractedData.links.join(', ') || 'None'}\n`;
            content += `â€¢ Financial Handles: ${extractedData.financial.join(', ') || 'None'}\n`;
            content += `â€¢ Trigger Words Detected: ${extractedData.triggers.join(', ') || 'None'}\n\n`;

            content += `[CHAT TRANSCRIPT]\n`;
            history.forEach(m => {
                const role = m.sender === 'scammer' ? 'SUSPECT' : 'AGENT';
                content += `[${role}]: ${m.text}\n`;
            });

            content += `\n--------------------------------------------------\n`;
            content += `CONFIDENTIAL - FOR AUTHORIZED USE ONLY`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CyberGuard_Report_${sessionId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Toast Notification
            const btn = document.getElementById('exportBtn');
            if (btn) {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="inline w-3 h-3"></i> EXPORTED`;
                btn.classList.add('bg-green-600', 'border-green-400', 'shadow-green-500/50');
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('bg-green-600', 'border-green-400', 'shadow-green-500/50');
                    lucide.createIcons(); // Re-render icon
                }, 2000);
            }
        }

        // --- CORE CHAT LOGIC ---
        // --- IDENTITY LOGIC ---
        // --- VOICE LOGIC ---
        let isVoiceEnabled = true;
        const synth = window.speechSynthesis;

        function speak(text) {
            if (!isVoiceEnabled || !synth) return;
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Natural') || v.name.includes('Female'));
            if (preferredVoice) utterance.voice = preferredVoice;
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            synth.speak(utterance);
        }

        function togglePolicePanel() {
            const panel = document.getElementById('police-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                speak("I've opened the safety guide for you. Please paste any content you're worried about, and I'll look at it gently.");
            }
        }

        async function runPoliceCheck() {
            const content = document.getElementById('police-content').value;
            const resDiv = document.getElementById('res-police');
            if (!content) return;

            resDiv.innerHTML = '<div class="animate-pulse text-blue-400">Performing gentle forensic scan...</div>';
            resDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/police/analyze-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_content: content })
                });
                const data = await response.json();
                const analysis = data.analysis;

                let html = `
                    <div class="font-bold text-blue-400 uppercase text-[9px]">Result: ${analysis.threat_level} THREAT</div>
                    <div class="text-white">${analysis.fraud_type}</div>
                    <div class="text-[9px] text-slate-400 italic">${analysis.recommendations[0]}</div>
                `;
                resDiv.innerHTML = html;
                speak(analysis.recommendations[0]);
            } catch (e) {
                resDiv.innerHTML = '<div class="text-red-400">Verification failed.</div>';
            }
        }

        // --- IDENTITY LOGIC ---
        function updateAgentIdentity() {
            const persona = document.getElementById('personaSelect').value;
            const chatHeader = document.querySelector('.text-[10px].text-slate-500.font-mono');
            if (persona === 'police') {
                chatHeader.innerText = "POLICE ADVISORY â€¢ ACTIVE ASSISTANCE";
                speak("Hello. I am Harsh. I've joined the session to help protect you. You can talk to me directly now.");
            } else {
                chatHeader.innerText = "ENCRYPTED CHANNEL â€¢ MONITORING";
            }
        }

        // --- CORE CHAT LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('mainInput');
            const text = input.value.trim();
            if (!text) return;

            // 1. UI Updates
            addMsg('scammer', text);
            input.value = '';
            document.getElementById('typing').classList.remove('hidden');

            const persona = document.getElementById('personaSelect').value;

            // Reset & Animate ML Card
            document.getElementById('ml-intent-text').innerText = "CALCULATING TENSORS...";
            document.getElementById('ml-intent-text').className = "text-center text-xs font-mono py-1.5 px-2 bg-indigo-900/30 text-indigo-300 border border-indigo-500/30 rounded animate-pulse";

            try {
                let res, data;
                if (persona === 'police') {
                    res = await fetch('/api/police/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: text })
                    });
                    data = await res.json();
                    data.reply = data.response; // Normalize for the rest of the logic
                } else {
                    res = await fetch(`${API_URL}/honeypot`, {
                        method: 'POST',
                        headers: { 'x-api-key': 'sk_test_123456789', 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            message: { sender: 'scammer', text: text, timestamp: new Date().toISOString() },
                            metadata: { persona: persona },
                            conversationHistory: history
                        })
                    });
                    data = await res.json();
                }

                // 2. Update History
                const timeStr = new Date().toISOString();
                history.push({ sender: 'scammer', text: text, timestamp: timeStr });
                if (data.reply) history.push({ sender: 'agent', text: data.reply, timestamp: timeStr });

                // 3. Simulate "Thinking" Delay for realism
                setTimeout(() => {
                    document.getElementById('typing').classList.add('hidden');
                    if (data.reply) {
                        addMsg('agent', data.reply, persona);
                        if (persona === 'police') speak(data.reply);
                    } else {
                        addMsg('system', "Agent failed to generate a reply.");
                    }

                    if (data.ml_analysis) {
                        updateMLStats(data.ml_analysis);
                    }

                    if (data.extracted_intelligence) {
                        updateIntel(data.extracted_intelligence);
                    }
                }, 800 + Math.random() * 500);

            } catch (e) {
                console.error(e);
                document.getElementById('typing').classList.add('hidden');
                addMsg('system', "Error connecting to Neural Engine. Please ensure backend is running.");
            }
        }

        function addMsg(role, text, persona = 'naive') {
            const c = document.getElementById('chatContainer');

            let html = '';
            if (role === 'system') {
                html = `<div class="text-center text-[10px] text-red-400 font-mono my-2 border border-red-900 bg-red-900/10 p-1 rounded">${text}</div>`;
            } else {
                const isAgent = role === 'agent';
                let senderName = 'UNKNOWN SOURCE';
                let styleClass = 'msg-scammer rounded-tr-none';

                if (isAgent) {
                    if (persona === 'police') {
                        senderName = 'POLICE OFFICER (AI)';
                        styleClass = 'bg-gradient-to-br from-blue-900/80 to-slate-900 border-l-4 border-blue-500 text-blue-100 rounded-tl-none';
                    } else {
                        senderName = 'SIMULATED TARGET';
                        styleClass = 'msg-agent rounded-tl-none';
                    }
                } else {
                    senderName = 'SUSPECT / INCOMING';
                }

                html = `
                <div class="flex flex-col ${isAgent ? 'items-start' : 'items-end'} mb-4 animate-[fadeIn_0.3s_ease-out]">
                    <div class="text-[9px] font-bold uppercase mb-1 ${isAgent ? 'text-blue-400' : 'text-slate-500'} tracking-wider">${senderName}</div>
                    <div class="max-w-[85%] p-3.5 rounded-2xl text-xs sm:text-sm leading-relaxed shadow-md ${styleClass}">
                        ${text}
                    </div>
                </div>`;
            }

            c.insertAdjacentHTML('beforeend', html);
            c.scrollTop = c.scrollHeight;
        }

        // --- ANALYTICS UI UPDATES ---
        function updateMLStats(ml) {
            currentML = ml; // Store global
            const conf = Math.round(ml.confidence * 100);
            const el = document.getElementById('ml-conf-text');
            const bar = document.getElementById('ml-bar');
            const intent = document.getElementById('ml-intent-text');

            // Determine Risk Color
            let colorClass = 'text-green-400';
            let barColor = 'bg-green-500';
            let riskLabel = 'LOW RISK';

            if (conf > 50) { colorClass = 'text-yellow-400'; barColor = 'bg-yellow-500'; riskLabel = 'MODERATE RISK'; }
            if (conf > 85) { colorClass = 'text-red-500'; barColor = 'bg-red-500'; riskLabel = 'CRITICAL THREAT'; }

            // Animate Counter
            let start = 0;
            const step = () => {
                start += 2;
                if (start > conf) start = conf;
                el.innerText = start + "%";
                el.className = `text-5xl font-bold tracking-tighter ${colorClass}`;
                if (start < conf) requestAnimationFrame(step);
            };
            step();

            // Update Bar & Text
            bar.className = `h-full ${barColor} transition-all duration-1000`;
            bar.style.width = conf + "%";

            intent.innerHTML = `<span class="${colorClass}">${riskLabel}:</span> ${(ml.intent || 'IDLE').toUpperCase().replace('_', ' ')}`;
            intent.className = "text-center text-xs font-mono py-1.5 px-2 bg-slate-800 rounded border border-slate-700 text-slate-300";
        }

        function updateIntel(intel) {
            const list = document.getElementById('intel-list');
            list.innerHTML = '';

            // ACCUMULATE DATA FOR EXPORT
            if (intel.phoneNumbers) extractedData.phones = [...new Set([...extractedData.phones, ...intel.phoneNumbers])];
            if (intel.phishingLinks) extractedData.links = [...new Set([...extractedData.links, ...intel.phishingLinks])];
            if (intel.upiIds) extractedData.financial = [...new Set([...extractedData.financial, ...intel.upiIds])];
            if (intel.suspiciousKeywords) extractedData.triggers = [...new Set([...extractedData.triggers, ...intel.suspiciousKeywords])];

            let hasData = false;

            const createItem = (icon, color, label, items) => {
                if (!items || items.length === 0) return;
                hasData = true;

                // Color mapping for static Tailwind classes
                const colorMap = {
                    'emerald': {
                        bg: 'bg-emerald-500/10',
                        border: 'border-emerald-500/10',
                        text: 'text-emerald-400'
                    },
                    'indigo': {
                        bg: 'bg-indigo-500/10',
                        border: 'border-indigo-500/10',
                        text: 'text-indigo-400'
                    },
                    'cyan': {
                        bg: 'bg-cyan-500/10',
                        border: 'border-cyan-500/10',
                        text: 'text-cyan-400'
                    },
                    'orange': {
                        bg: 'bg-orange-500/10',
                        border: 'border-orange-500/10',
                        text: 'text-orange-400'
                    }
                };

                const colors = colorMap[color] || colorMap['indigo'];

                const itemsHtml = items.map(i => `
                    <div class="flex items-center justify-between group cursor-pointer hover:bg-slate-700/50 p-1.5 rounded transition">
                        <span class="truncate font-mono text-slate-300 select-all">${i}</span>
                        <i data-lucide="copy" class="w-3 h-3 text-slate-600 opacity-0 group-hover:opacity-100" onclick="navigator.clipboard.writeText('${i}')"></i>
                    </div>
                `).join('');

                list.innerHTML += `
                <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl overflow-hidden mb-2">
                    <div class="${colors.bg} px-3 py-2 border-b ${colors.border} flex items-center gap-2">
                        <i data-lucide="${icon}" class="w-3 h-3 ${colors.text}"></i>
                        <span class="text-[10px] font-bold uppercase ${colors.text} tracking-wider">${label}</span>
                    </div>
                    <div class="p-2 space-y-1 text-[11px]">
                        ${itemsHtml}
                    </div>
                </div>`;
            };

            // DISPLAY CUMULATIVE DATA
            createItem('phone', 'emerald', 'Identified Numbers', extractedData.phones);
            createItem('link', 'indigo', 'Malicious Links', extractedData.links);
            createItem('credit-card', 'cyan', 'Financial Handles', extractedData.financial);
            createItem('alert-triangle', 'orange', 'Trigger Words', extractedData.triggers);

            if (!hasData && extractedData.phones.length === 0 && extractedData.links.length === 0) {
                list.innerHTML = `<div class="text-center py-6 text-slate-600 italic text-xs">No threats extracted from this payload.</div>`;
            }

            lucide.createIcons();
        }

        // --- EXTERNAL TOOLS LOGIC ---
        async function runCheck(type) {
            const val = document.getElementById(`check-${type}`).value;
            const resBox = document.getElementById(`res-${type}`);
            if (!val) return;

            resBox.innerHTML = '<div class="flex items-center gap-2 text-slate-400"><i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Querying databases...</div>';
            resBox.classList.remove('hidden');
            lucide.createIcons();

            try {
                const res = await fetch(`${API_URL}/check`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, value: val })
                });
                const data = await res.json();

                // Style results
                let score = data.score !== undefined ? data.score : 0;
                let riskColor = score > 0.7 ? 'text-red-400' : (score > 0.4 ? 'text-orange-400' : 'text-emerald-400');
                let detailsHtml = (data.details && Array.isArray(data.details)) ? data.details.map(d => `<div class="text-slate-400">â€¢ ${d}</div>`).join('') : '<div class="text-slate-500 italic">No specific details verified.</div>';

                resBox.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-slate-200">Analysis Result</span>
                    <span class="font-mono font-bold ${riskColor}">${(score * 100).toFixed(0)}% RISK</span>
                </div>
                <div class="space-y-1 text-slate-500 font-mono text-[10px]">
                    ${detailsHtml}
                    ${data.carrier ? `<div>CARRIER: <span class="text-slate-300">${data.carrier}</span></div>` : ''}
                    ${data.location ? `<div>LOC: <span class="text-slate-300">${data.location}</span></div>` : ''}
                    ${data.flag ? `<div class="text-red-400 font-bold mt-1">ðŸš© ${data.flag}</div>` : ''}
                </div>
            `;

            } catch (e) {
                resBox.innerHTML = `<span class="text-red-500">Error: Could not verify.</span>`;
            }
        }

        // --- VOICE DETECTION LOGIC (Problem Statement 1) ---
        let selectedAudioBase64 = null;

        function handleVoiceFile(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.type !== "audio/mpeg" && !file.name.endsWith('.mp3')) {
                alert("Only MP3 files are supported.");
                input.value = "";
                return;
            }

            const label = document.getElementById('file-label');
            label.innerText = file.name.substring(0, 10) + "...";

            const reader = new FileReader();
            reader.onload = function (e) {
                // Get Base64 string without the prefix
                selectedAudioBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        async function runVoiceDetection() {
            const lang = document.getElementById('voice-lang').value;
            const resDiv = document.getElementById('res-voice');
            const btn = document.getElementById('voice-btn');

            if (!selectedAudioBase64) {
                alert("Please upload an MP3 file first.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> PROCESSING...';
            lucide.createIcons();

            resDiv.innerHTML = '<div class="text-amber-400 animate-pulse">Scanning audio frequencies for synthetic markers...</div>';
            resDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/voice-detection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'sk_test_123456789'
                    },
                    body: JSON.stringify({
                        language: lang,
                        audioFormat: "mp3",
                        audioBase64: selectedAudioBase64
                    })
                });

                const data = await response.json();

                if (data.status === "success") {
                    const color = data.classification === "AI_GENERATED" ? "text-red-400" : "text-green-400";
                    const badge = data.classification === "AI_GENERATED" ? "bg-red-500/20 border-red-500/30" : "bg-green-500/20 border-green-500/30";

                    resDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-bold ${color}">${data.classification}</span>
                            <span class="px-2 py-0.5 rounded border ${badge} ${color} text-[8px] font-mono">${(data.confidenceScore * 100).toFixed(0)}% CONFIDENCE</span>
                        </div>
                        <div class="text-slate-300 leading-relaxed">${data.explanation}</div>
                        <div class="text-[8px] text-slate-500 uppercase tracking-tighter">Forensic Node: CyberGuard-Voice-V1</div>
                    `;
                } else {
                    resDiv.innerHTML = `<div class="text-red-400">Error: ${data.message}</div>`;
                }
            } catch (error) {
                resDiv.innerHTML = '<div class="text-red-400">System intercept error during voice analysis.</div>';
            } finally {
                btn.disabled = false;
                btn.innerText = 'ANALYZE VOICE ORIGIN';
                lucide.createIcons();
            }
        }
    </script>
</body>

</html>